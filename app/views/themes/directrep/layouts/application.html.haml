
!!! Strict
%html{html_attrs}
  %head{ :profile => "http://gmpg.org/xfn/1" }
    = csrf_meta_tags

    - cache [current_tenant] do 

      %title
        = "#{@title && @title != '' ? @title + " - " : ''}#{current_tenant.app_title}"
            
      %link{ :href => "#{current_theme_image_path 'favicon.ico'}", :rel => "icon", :type => "image/vnd.microsoft.icon" }
      %meta{ :content => 'text/html; charset=UTF-8', "http-equiv" => "Content-Type" }
      
      %meta{ :name => 'keywords', :content => "#{@keywords ? @keywords : ''}"}

      %meta{ :name => 'description', :content => "#{@description ? @description : ''}"}

      %meta{ :name => "google-site-verification", :content => "" }
        
      = theme_stylesheet_link_tag 'application'

      //%link{ :href => "/system/cache/#{current_tenant.identifier}.css", :type => 'text/css', :media => "screen", :rel => "stylesheet"}


      /[if IE 9]
        = stylesheet_link_tag 'browser/ie/ie9'
      
      /[if lte IE 8]
        = stylesheet_link_tag 'browser/ie/ie'


      :javascript
        //http://blog.colin-gourlay.com/blog/2012/02/safely-using-ready-before-including-jquery/
        (function(w,d,u){w.readyQ=[];w.bindReadyQ=[];function p(x,y){if(x=="ready"){w.bindReadyQ.push(y);}else{w.readyQ.push(x);}};var a={ready:p,bind:p};w.$=w.jQuery=function(f){if(f===d||f===u){return a}else{p(f)}}})(window,document)

        $(document).ready(function(){
          sevenUp.plugin.black.test({});    

          var stylesheet = document.createElement('link');
          stylesheet.href = "/system/cache/#{current_tenant.identifier}.css";
          stylesheet.rel = 'stylesheet';
          stylesheet.type = 'text/css';
          document.getElementsByTagName('head')[0].appendChild(stylesheet);


          ConsiderIt.init(); 
          $(window).bind('page:change', function() {
            ConsiderIt.init();
          });

          

        });   

      = render :partial => 'backbone/templates'

      :javascript
        window.cached_avatars_loaded = false;

        (function() {
          var httpRequest;
         
          function makeRequest(url) {
            if (window.XMLHttpRequest) { // Mozilla, Safari, ...
              httpRequest = new XMLHttpRequest();
            } else if (window.ActiveXObject) { // IE
              try {
                httpRequest = new ActiveXObject("Msxml2.XMLHTTP");
              } 
              catch (e) {
                try {
                  httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
                } 
                catch (e) {}
              }
            }
         
            if (!httpRequest) {
              alert('Giving up :( Cannot create an XMLHTTP instance');
              return false;
            }
            httpRequest.onreadystatechange = alertContents;
            httpRequest.open('GET', url);
            httpRequest.send();
          }
         
          function alertContents() {
            if (httpRequest.readyState === 4) {
              if (httpRequest.status === 200) {
                window.avatar_data = (JSON && JSON.parse(httpRequest.responseText)) || ($ && $.parseJSON(httpRequest.responseText)); 
                window.cached_avatars_loaded = true;

                if(window.avatars) { 
                  window.avatars.load_avatars();
                }
              } else {
                console.log('Could not fetch avatars');
              }
            }
          }
          //makeRequest("/system/cache/#{current_tenant.identifier}.json");

        })();

      = theme_javascript_include_tag 'application', :async => true # => Rails.env.production?


  - theme = Themes::ThemeDirectrep.find_by_account_id(current_tenant.id)
  - cache [current_tenant, theme, @dashboard] do 
    - aarp = false

    %body

      %svg{ :xmlns => "http://www.w3.org/2000/svg", :height => 0, :style => "position: absolute", :version => "1.1", :baseProfile => "full" }

        %defs
          %filter{ :id => "bubble_gradient"}
            %feImage{ :x => "10", :y => "0", :'xlink:href' => "/assets/bubble_gradient.png", :result => "overlay" }
            %feOffset{ :dy => ".2", :dx => "0" }  
            //%feBlend{ :in2 => "SourceGraphic", :in1 => "overlay", :mode => "lighten" }
            %feComposite{ :in2 => "SourceGraphic", :operator => "over" }

      #l-wrap
        = render :partial => "shared/flash_messages"
        = render :partial => "shared/header/container"

        #l-content
          - if false && Rails.env.development?
            = render :partial => "shared/dev_tools"      

          - if @dashboard
            = render :partial => "dashboard/sidebar"  


          .l-content-wrap
            - rep_user = theme.user
              
            .t-dr-mock-dialogue

              %h1.t-dr-heading
                - if aarp
                  = image_tag current_theme_image_path("aarp_logo.png")
                  = image_tag current_theme_image_path("logo.png")

                - else
                  %span.rep{:title => "#{theme.rep_name}"}
                    = theme.rep_name
                  %span.dialogue{:title => "wants to hear from"}
                    wants to hear from
                  %span.constituency{:title => "You"}
                    You

              .l-message-speaker.rep
                = image_tag current_theme_image_path("#{theme.rep_name.gsub(' ', '_').downcase}.png")

                .t-dr-leader-desc
                  .t-leader-desc-about
                    = theme.rep_about
                  .t-dr-leader-media
                    %a
                      website 
                    ★
                    %a
                      twitter
                    ★ 
                    %a
                      facebook

              .l-message-body
                .rep_statement.left
                  = render :partial => "shared/bubble", :locals => {:left => true}

                  %strong
                    - if !aarp
                      Tell me what you think about the issues below. 
                    - else
                      Tell us what you think about the issues below.

                  - if !aarp
                    I want to be able to represent the residents of Framingham and Ashland well as we consider these issues in the State House. 
                    
                    //I want to be able to represent the residents of Moanalua, Salt Lake and Aliamanu as we consider these issues in the State House.
                  - else
                    We want to represent our members as our government consider these important policy issues that will effect the lives of our members.

                .constituent_statement.right
                  //.t-bubble
                  = render :partial => "shared/bubble", :locals => {:left => false}
          
                  - if !aarp
                    Why should we spend the time? Politicians don't care what we think.
                  - else
                    Why should we spend time?  Does the AARP really care what we think?

                .rep_statement.left
                  = render :partial => "shared/bubble", :locals => {:left => true}
      
                  %strong
                    - if !aarp
                      I promise to post a response to your concerns.
                    - else
                      Your voice powers the AARP.  

                  - if !aarp
                    Your opinions help shape how I look at these important issues for our community. I care what you think.
                  - else
                    Your opinions help shape how we as an organization can respond to these important issues.  We care what you think.

              .l-message-recipient.l-group-container
                - cols = 10
                - rows = 13
                - pics = User.where('avatar_file_name IS NOT NULL')
                - users = pics.sample( [cols*rows, pics.count].min )

                - users.each do |user|
                  %span.avatar{ :id => "avatar-#{user.id}", :'data-id' => user.id }

          .m-proposals-heading

            .m-proposals-sort-container
              .title
                Sort issues by: 
              %a.selected.activity
                Most active
              %a.newest
                Newest

            .m-proposals-filter-container
              .title
                Filter to: 
              %a.selected.all
                All
              %a.open
                Open
              %a.completed
                Completed

          #m-proposals-container
            %ul.m-proposal-list

        = render :partial => "shared/footer/container"

        //$.get("/system/cache/#{current_tenant.identifier}.json", function(data) { 
        //  window.avatar_data = data;
        //  window.avatars.load_avatars();
        //});

      = render :partial => 'backbone/data'        

      - if APP_CONFIG[:analytics][:google] && APP_CONFIG[:analytics][:google] != ''
        :javascript
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', "#{current_tenant.analytics_google}"]);
          _gaq.push(['_setDomainName', ".#{get_root_domain}"]);
          _gaq.push(['_trackPageview']);


      - if current_tenant.analytics_google && current_tenant.analytics_google != ''
        :javascript
          var _gaq_account = _gaq_account || [];
          _gaq_account.push(['_setAccount', "#{current_tenant.analytics_google}"]);
          _gaq_account.push(['_trackPageview']);

    
