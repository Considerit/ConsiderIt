#!/usr/bin/env ~/Documents/code/castanaut/bin/castanaut

#####
# Uses castanaut to automate a screencast in safari. The robot voice sections, 
# as created via while_saying, help to space out the video for timing
# purposes. 
#
#
# Installation:
#   - must be installed on a mac
#   - Castanaut should be installed from https://github.com/tkriplean/castanaut
#
# Execution:
#   - must be run on a mac
#   - /path/to/castanaut/bin/castanaut /path/to/this/file
#   - can be invoked from bin/screencast, but the path to in bin/screencast is
#     hardcoded for Travis...talk to him if you can't get it to run.  

# TODO: 
#  - refactor into general methods so we can create other screencasts or tests
#    more easily
#  - find a way to automatically destroy any opinions created here. 


#####
# Prep for this screencast: 
# 
# > rake prep_deathstar

#####
# config

# By default, this script will only launch and control a safari instance. 
# Setting 'record_video_with' to "camtasia" or "quicktime" will also launch
# cause a screen recording to be created. 
record_video = true

export_to = File.absolute_path(File.join(File.dirname(screenplay), 'exports', File.basename(screenplay)))


# height of safari window bar + toolbar + apple menu
y_offset = 63

# shaves off rounded window corners
window_padding = 15 

# controls the size and location of the screencast main area
x, y, width, height = [window_padding, y_offset, 1280, 720] 

#####
# Screencast guts

if record_video
  plugin "quicktime"
  start_recording(x, y, width, height)
  pause 2
end


plugin "safari"

launch "Safari", at(x - window_padding, y - y_offset, width + window_padding * 2, height + y_offset + window_padding) 

while_saying "loading page" do
  url "http://localhost:3000/Death_Star?domain=fun"
  wait_for_element('.proposal_header')
  pause 1
end

perform "Let's make sure we're logged in" do
  wait_for_element('#user_nav')
  move to_element('.profile_anchor.login'), {:speed => 0.1} rescue skip
  pause 1
  click
  wait_for_element('#user_email')
  move to_element('#user_email'), {:speed => 0.1}
  click
  type "test@test.dev.ghost", {:speed => 10}
  move to_element('#user_password'), {:speed => 0.1}
  click

  type "testtest", {:speed => 10}

  move to_element('.primary_button'), {:speed => 0.1}
  click
  wait_for_element('.proposal_header')
end







while_saying "Sometimes an issue comes up that requires some thought" do   
  scroll_to ".proposal_header", 0, 0
  move to_element('.proposal_header'), {:speed => 0.01}  
  pause 4
end

scroll_to ".proposal_header", 0, 0

wait_for_element('.histogram')
scroll_to ".histogram", 1000, 0

while_saying "The Pro con list encourages you to think about tradeoffs" do
  pause 2
  move to_element(".cons_on_decision_board .points_heading_label"), {speed: 2}
  pause 1
end

pause 1

while_saying "Write singular points that each describe a consideration" do
  move to_element(".write_cons"), {:speed => 2}
  click
  type "Could create brand issues. Do we want to be associated with an overtly imperialistic entity?", {
    :speed => 50
  }
  move to_element('[data-action="submit-point"]')
  click
  pause 1
end

pause 1

while_saying "Learn and build from otherâ€™s thoughts" do 
  pause 1

  move to_element('[data-id="/point/5508"]')
  pause 1.5
  move to_element('[data-id="/point/5499"]')
  pause 1.5
  move to_element('[data-id="/point/5505"]')
  pause 1.5  
  drag by(-280, -250), {:speed => 1}
  pause 1
end

pause 1

while_saying """
  Use a slider to express your conclusion, allowing more nuance 
  than a like or dislike""" do 

  move to_element('.the_handle', {:area => ['middle', 'top']})
  drag by(250, 0)
  pause 0.25
  drag by(-100, 0)
  pause 0.25
end

pause 2

while_saying """After creating a considered opinion, 
  individuals integrate their opinion 
  with the group""" do 
  move to_element('.save_opinion_button'), {:speed => 2}
  pause 0.5
  click
end

pause 2

while_saying "Histogram shows faces of individuals along spectrum of opinion." do
  move to_element('.histogram', {:area => ['left', 'bottom']})
end

while_saying "Points are ranked by how salient they are across the whole population" do 
  move to_element('.points_heading_label')
end

pause 1.5

while_saying "Now you can explore patterns of thought!" do 
  move to_element('.histogram', {:area => ['center', 'top'], :edge_offset => 25})
  click
  pause 1
  move to_element('.histogram', {:area => ['right', 'top'], :edge_offset => 25}), {:speed => 3}
  move to_element('.histogram', {:area => ['left', 'top'], :edge_offset => 25}), {:speed => 6}
end

while_saying "Inspect the most important factors to those who have reservations about this idea" do
  pause 2
  move by(50, 350)
  pause 1
  move to_element ".points_heading_label"
  click
  pause 2
end

pause 1

while_saying "See what a particular individual believes" do 
  move to_element(".avatar-282314")
  click
  pause 4
  move to_element(".avatar-282161"), {:speed => 2}
  click
  pause 3.5  
  click
  move to_element(".pros_by_community .points_heading_label"), {speed: 2}
end

pause 2

while_saying "Figure out who has been persuaded by the top pro points." do 
  perform 'tricky' do 
    move to_element(".pros_by_community .includers", {index: 0}), {speed: 2}
    pause 1.5
    move to_element("[data-id='/point/5505'] .includers") rescue skip
    pause 1.5
    move to_element("[data-id='/point/5513'] .includers") rescue skip
    pause 1.5
  end
end

pause 1

move to_element(".pros_by_community .points_heading_label"), {speed: 2}

while_saying "Drill into points for focused discussion" do 
  scroll_to '[data-id="/point/5502"]', 2000, 50
  move to_element('[data-id="/point/5502"]'), {speed: 2}
  pause 1.5
  click
  wait_for_element '.comment_entry'
  move to_element('.comment_entry')
  pause 1
  move to_element('.new_comment')
  click
  type "Perhaps we need to consider whether the \"Dark Force\" is aligned with our 15 year vision first...", {:speed => 30} 
  pause 0.5
  move to_element('[data-action="save-comment"]'), {:speed => 2} 
  click
  pause 1
end

move to_element('[data-id="/point/5502"]')
click

pause 1
scroll_to ".proposal_header", 2000, 0
move to_element('.proposal_header')
pause 4




########
# cleanup

while_saying "cleanup comments, points, inclusions" do

  perform "clean up added comments" do 
    scroll_to '[data-id="/point/5502"]', 0, 50
    move to_element('[data-id="/point/5502"]'), {:speed => 0.1}
    click
    pause 1
    while true
      move to_element('[data-action="delete-comment"]'), {:speed => 0.1} rescue skip
      click
      pause 1
      hit Enter
    end
    move to_element('[data-id="/point/5502"]')
    click
  end

  scroll_to ".histogram", 0, 0

  move to_element('.decision_board_body'), {:speed => 0.1}
  click
  pause 2

  perform "clean up written points" do 
    while true
      move to_element('.cons_on_decision_board [data-action="delete-point"]', {:speed => 0.1}) rescue skip
      move by(0, 3), {:speed => 0.1}
      click
      pause 1
      hit Enter
    end
  end

  move to_element('[data-id="/point/5505"]'), {:speed => 0.1}
  drag by(150, 0), {:speed => 1}

  scroll_to '.profile_menu_wrap', 0, 0
  move to_element('.profile_menu_wrap'), {:speed => 0.1}
  pause 0.5
  move to_element('[data-action="logout"]'), {:speed => 0.1}
  click
end

at_end_of_movie do
  if record_video
    stop_recording(export_to)
  end
end
